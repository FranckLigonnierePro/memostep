name: Auto PR on New Issue

on:
  issues:
    types: [opened]

jobs:
  autofix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # ✅ Crée la branche
      - name: Create branch with placeholder
        run: |
          git config user.email "bot@github.com"
          git config user.name "AutoFix Bot"
          git checkout -b "fix/issue-${{ github.event.issue.number }}"
          echo "Auto fix placeholder" > autofix.txt
          git add autofix.txt
          git commit -m "Auto fix placeholder for issue #${{ github.event.issue.number }}"
          git push --set-upstream origin "fix/issue-${{ github.event.issue.number }}"

      # ✅ Correction IA (si tu veux)
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install OpenAI SDK
        run: npm install openai@4.0.0

      - name: Generate AI Fix
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node scripts/autofix.js "${{ github.event.issue.title }}" "${{ github.event.issue.body }}"

      - name: Apply AI patch
        run: |
          git config user.email "bot@github.com"
          git config user.name "AutoFix Bot"
          git checkout "fix/issue-${{ github.event.issue.number }}"
          git apply --reject --whitespace=fix autofix.patch || echo "Patch rejected or partial"
          git add .
          git commit -m "AI fix for issue #${{ github.event.issue.number }}" || echo "No changes from patch"
          git push origin "fix/issue-${{ github.event.issue.number }}"  

      # ✅ ✅ Crée la PR APRÈS le commit final
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "fix/issue-${{ github.event.issue.number }}"
          base: "main"
          title: "Auto fix for issue #${{ github.event.issue.number }}"
          body: "PR auto-générée ✅ Issue liée #${{ github.event.issue.number }}"
